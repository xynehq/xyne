schema zoho_ticket {

  document zoho_ticket {

    ##########################################
   # 0. System Fields (Required for all documents)
    ##########################################

   # Workspace identifier for multi-tenancy
    field workspaceExternalId type string {
      indexing: attribute | summary
      attribute: fast-search
      match: exact
    }

   # App identifier (always "zoho-desk" for Zoho tickets)
    field app type string {
      indexing: attribute | summary
      attribute: fast-search
      match: exact
    }

   # Entity type (always "ticket" for Zoho tickets)
    field entity type string {
      indexing: attribute | summary
      attribute: fast-search
      match: exact
    }

   # Permissions array - contains department IDs that can access this ticket
   # Users can only see tickets from their associated departments
    field permissions type array<string> {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Document ID used by Vespa for URL construction (same as ticket ID)
    field docId type string {
      indexing: attribute | summary
      attribute: fast-search
    }

    ##########################################
   # 1. Core Identifiers
    ##########################################

   # Unique Zoho ticket ID (internal system identifier)
    field id type string {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Customer-facing ticket number (shown to end-users)
    field ticketNumber type string {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Department ID in Zoho (used for access control or routing)
    field departmentId type string {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Department display name (e.g. "Support", "Engineering")
   # Helps filtering and analytics by department.
    field departmentName type string {
      indexing: attribute | summary | index
      attribute: fast-search
      index: enable-bm25
    }

   # Account (company) name that owns the ticket (from accountId mapping)
   # Useful for org-level analytics (e.g., all tickets from a merchant).
    field accountName type string {
      indexing: attribute | summary | index
      attribute: fast-search
      index: enable-bm25
    }

   # Product or service name related to the issue (from productId)
   # Enables product-based search filters.
    field productName type string {
      indexing: attribute | summary | index
      attribute: fast-search
      index: enable-bm25
    }

   # Team name to which the ticket is assigned
    field teamName type string {
      indexing: attribute | summary | index
      attribute: fast-search
      index: enable-bm25
    }

    ##########################################
   # 2. Core Ticket Fields
    ##########################################

   # Ticket subject/title; main searchable text
    field subject type string {
      indexing: index | summary
      index: enable-bm25
    }

   # Ticket body (customer issue description)
    field description type string {
      indexing: index | summary
      index: enable-bm25
    }

   # Category grouping (e.g., "Production Configurations")
   # For broad classification and filtering.
    field category type string {
      indexing: attribute | summary | index
      attribute: fast-search
      index: enable-bm25
    }

   # Sub-category for finer classification
    field subCategory type string {
      indexing: attribute | summary | index
      attribute: fast-search
      index: enable-bm25
    }

   # Ticket type: Incident, Problem, Request, or Question
    field classification type string {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Ticket urgency (High, Medium, Low)
    field priority type string {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Current ticket state (Open, Closed, On Hold)
    field status type string {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Resolution summary entered by the agent when closing ticket
   # Useful for search queries like "how was this fixed".
    field resolution type string {
      indexing: attribute | summary | index
      index: enable-bm25
    }

   # URL to open the ticket directly in Zoho Desk
    field webUrl type string {
      indexing: attribute | summary
    }

   # Source of ticket creation (Agent, System, API, Manual)
    field sourceType type string {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Contact email - the email address of the customer/requester who created the ticket
   # This is typically pulled from ticket.contact.email or ticket.email
   # Used for filtering tickets by customer and BM25 search on email addresses
    field contactEmail type string {
      indexing: attribute | summary | index
      attribute: fast-search
      index: enable-bm25
    }

   # Assigned agent's email
    field assigneeEmail type string {
      indexing: attribute | summary | index
      attribute: fast-search
      index: enable-bm25
    }

   # Ticket creator (could be system or human agent)
    field createdByEmail type string {
      indexing: attribute | summary | index
      attribute: fast-search
      index: enable-bm25
    }

   # Last person/system who modified the ticket
    field modifiedByEmail type string {
      indexing: attribute | summary | index
      attribute: fast-search
      index: enable-bm25
    }

   # Channel through which ticket was created (Email, Phone, Chat, Web, etc.)
    field channel type string {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Shared departments (tickets visible to multiple departments)
    field sharedDepartments type array<string> {
      indexing: attribute | summary
      attribute: fast-search
    }

    ##########################################
   # 3. Boolean Flags
    ##########################################

   # True if SLA for resolution was breached
    field isOverDue type bool { indexing: attribute | summary }

   # True if SLA for first response was breached
    field isResponseOverdue type bool { indexing: attribute | summary }

   # True if the ticket is escalated for higher attention
    field isEscalated type bool { indexing: attribute | summary }

    ##########################################
   # 4. Time Fields
    ##########################################

   # Ticket creation time (epoch ms)
    field createdTime type long {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Last modification time
    field modifiedTime type long {
      indexing: attribute | summary
    }

   # Ticket closure time
    field closedTime type long {
      indexing: attribute | summary
    }

   # SLA due date for resolution
    field dueDate type long {
      indexing: attribute | summary
    }

   # Derived: Duration between created and closed (in days)
   # Helps in SLA analytics and aging reports.
    field daysToClose type double {
      indexing: attribute | summary
      attribute: fast-access
    }

    ##########################################
  # 5. Derived & NLP Summaries
    ##########################################

   # Summarized conversation of all threads
    field threadSummary type string {
      indexing: index | summary
      index: enable-bm25
    }

   # Summarized agent comments (internal + customer-facing)
    field commentSummary type string {
      indexing: index | summary
      index: enable-bm25
    }

   # NLP summary representing ticket journey (from creation to resolution)
    field wholeResolutionSummary type string {
      indexing: index | summary
      index: enable-bm25
    }

   # Flattened array of all thread message texts (for BM25 keyword search)
   # No embeddings - use threadSummary_embedding for semantic search
    field threadMessages type array<string> {
      indexing: index | summary | attribute
      attribute: fast-search
      index: enable-bm25
    }

   # Flattened array of all comment message texts (for BM25 keyword search)
   # No embeddings - use commentSummary_embedding for semantic search
    field commentMessages type array<string> {
      indexing: index | summary | attribute
      attribute: fast-search
      index: enable-bm25
    }

   # Flattened array of all attachment OCR texts (for BM25 keyword search)
   # Includes ticketAttachments + thread attachments + comment attachments
   # No embeddings - use wholeResolutionSummary_embedding for semantic search
    field attachmentTexts type array<string> {
      indexing: index | summary | attribute
      attribute: fast-search
      index: enable-bm25
    }

   # Email recipients (for thread-based search)
    field to type array<string> {
      indexing: index | summary | attribute
      attribute: fast-search
      index: enable-bm25
    }
   # CC recipients
    field cc type array<string> {
      indexing: index | summary | attribute
      attribute: fast-search
      index: enable-bm25
    }

   # BCC recipients (rare but included for completeness)
    field bcc type array<string> {
      indexing: index | summary | attribute
      attribute: fast-search
      index: enable-bm25
    }

   # Mentions (users tagged in threads/comments)
    field mentions type array<string> {
      indexing: index | summary | attribute
      attribute: fast-search
      index: enable-bm25
    }

    ##########################################
  # 6. Thread & Comment Structures
    ##########################################

  # Struct: individual attachment info (e.g., logs, screenshots)
    struct attachmentType {
      field attachmentId type string {}
      field attachmentName type string {}
      field attachmentDetail type string {}
      field attachmentUrl type string {}
      field processingStatus type string {}
      field fileType type string {}
      field size type long {}
    }

   # Struct: one message in thread or comment
   # Includes id, text, author, attachments, and reference link
    struct messageSchema {
      field id type string {}
      field messageText type string {}
      field attachmentDetails type array<attachmentType> {}
      field authorEmail type string {}
      field link type string {}
      field createdTime type string {}
    }

   # All conversation threads in ticket
    field threads type array<messageSchema> {
      indexing: summary
    }

   # All comments (agent or system)
    field comments type array<messageSchema> {
      indexing: summary
    }

   # Ticket-level attachments (not in threads/comments)
    field ticketAttachments type array<attachmentType> {
      indexing: summary
    }

    ##########################################
  # 7. Custom Fields (Business-specific fields from Zoho Desk)
    ##########################################

   # Merchant identifier for the ticket
   # Used to filter and search tickets by specific merchant/customer account
    field merchantId type string {
      indexing: attribute | summary
      attribute: fast-search
    }

   # Product details or description associated with the ticket
   # Searchable via BM25 for product-specific ticket queries
    field productDetails type string {
      indexing: attribute | summary | index
      index: enable-bm25
    }

   # Timestamp when the first response was sent to the customer
   # Useful for SLA tracking and response time analytics
    field firstResponseTime type string {
      indexing: attribute | summary
    }

   # Timestamp when the ticket was resolved or closed
   # Used for resolution time analytics and SLA compliance
    field resolutionTime type string {
      indexing: attribute | summary
    }

   # Timestamp when the ticket was put on hold
   # Tracks when ticket work was paused
    field onHoldStartTime type string {
      indexing: attribute | summary
    }

   # Timestamp when the ticket was taken off hold
   # Tracks when ticket work resumed after being paused
    field onHoldEndTime type string {
      indexing: attribute | summary
    }

   # Timestamp when ticket escalation ended
   # Useful for tracking escalation duration and resolution
    field escalatedEndDate type string {
      indexing: attribute | summary
    }
  }

  ##########################################
  # 8. Embeddings (for Semantic Search - outside document block)
  ##########################################

  # Semantic vector for subject
  field subject_embedding type tensor<bfloat16>(v[768]) {
    indexing: input subject | embed | attribute | index
    attribute { distance-metric: angular }
  }

  # Semantic vector for description
  field description_embedding type tensor<bfloat16>(v[768]) {
    indexing: input description | embed | attribute | index
    attribute { distance-metric: angular }
  }

  # Semantic vector for thread summary
  field threadSummary_embedding type tensor<bfloat16>(v[768]) {
    indexing: input threadSummary | embed | attribute | index
    attribute { distance-metric: angular }
  }

  # Semantic vector for comment summary
  field commentSummary_embedding type tensor<bfloat16>(v[768]) {
    indexing: input commentSummary | embed | attribute | index
    attribute { distance-metric: angular }
  }

  # Semantic vector for end-to-end resolution summary
  field wholeResolutionSummary_embedding type tensor<bfloat16>(v[768]) {
    indexing: input wholeResolutionSummary | embed | attribute | index
    attribute { distance-metric: angular }
  }

  ##########################################
  # 9. Fuzzy Autocomplete (outside document block)
  ##########################################

  # Used for auto-suggest and partial matches on subject
  field subject_fuzzy type string {
    indexing: input subject | index
    index {
      enable-bm25
    }
    match {
      gram
      gram-size: 3
    }
  }

  ##########################################
  # 10. Fieldsets (for query scoping)
  ##########################################
  fieldset default {
    fields: subject, description, threadSummary, commentSummary, wholeResolutionSummary
  }

  fieldset autocomplete {
    fields: subject
  }

  ##########################################
  # 11. Rank Profiles
  ##########################################

  # Standard lexical BM25 relevance
  rank-profile default_bm25 {
    constants {
      SUBJECT_WEIGHT: 2.0
      DESCRIPTION_WEIGHT: 1.5
      THREAD_WEIGHT: 1.0
      COMMENT_WEIGHT: 0.5
      RESOLUTION_WEIGHT: 1.0
    }
    first-phase {
      expression: (SUBJECT_WEIGHT * bm25(subject)) + (DESCRIPTION_WEIGHT * bm25(description)) + (THREAD_WEIGHT * bm25(threadSummary)) + (COMMENT_WEIGHT * bm25(commentSummary)) + (RESOLUTION_WEIGHT * bm25(wholeResolutionSummary))
    }
  }

  # Hybrid: combines BM25 + vector similarity
  rank-profile hybrid {
    inputs {
      query(q) tensor<bfloat16>(v[768])
      query(alpha) double
    }
    constants {
      THREAD_EMB_WEIGHT: 0.5
      DESCRIPTION_EMB_WEIGHT: 0.2
      SUBJECT_EMB_WEIGHT: 0.1
      COMMENT_EMB_WEIGHT: 0.1
      RESOLUTION_EMB_WEIGHT: 0.1
    }
    first-phase {
      expression: query(alpha) * ((THREAD_EMB_WEIGHT * closeness(field, threadSummary_embedding)) + (DESCRIPTION_EMB_WEIGHT * closeness(field, description_embedding)) + (COMMENT_EMB_WEIGHT * closeness(field, commentSummary_embedding)) + (SUBJECT_EMB_WEIGHT * closeness(field, subject_embedding)) + (RESOLUTION_EMB_WEIGHT * closeness(field, wholeResolutionSummary_embedding)))
    }
  }

  # Base rank profile with common functions and constants
  rank-profile initial {
    inputs {
      query(e) tensor<bfloat16>(v[768])
      query(alpha) double
      query(recency_decay_rate) double
    }

    constants {
      THREE_MONTHS_IN_SECONDS: 7890000
      ONE_YEAR_IN_SECONDS: 31536000
      MAX_DOC_DECAY: 0.5
    }

    function document_age() {
      expression: max(if(isNan(attribute(createdTime)) == 1, THREE_MONTHS_IN_SECONDS, now() - (attribute(createdTime) / 1000)) / ONE_YEAR_IN_SECONDS, 0)
    }

    function doc_recency() {
      expression: max(1 / (1 + query(recency_decay_rate) * sqrt(document_age)), MAX_DOC_DECAY)
    }

    function vector_score() {
      expression: (closeness(field, threadSummary_embedding) + closeness(field, description_embedding) + closeness(field, subject_embedding)) / 3
    }

    function combined_bm25() {
      expression: bm25(subject) + bm25(description) + bm25(threadSummary) + bm25(commentSummary)
    }

    function matchedFieldCount() {
      expression {
        matches(subject) + matches(description) + matches(threadSummary) + matches(commentSummary)
      }
    }

    function combined_nativeRank() {
      expression: (nativeRank(subject) + nativeRank(description) + nativeRank(threadSummary) + nativeRank(commentSummary)) / if(matchedFieldCount == 0, 1, matchedFieldCount)
    }
  }

  # Time-based sorted rank profile for recency-focused queries
  # rank-profile global_sorted inherits initial {
  #   inputs {
  #     query(bin_size_days) double: 1.0
  #   }

  #   constants {
  #     ONE_DAY_IN_SECONDS: 86400.0
  #     RECENCY_BIN_MULTIPLIER: 1000000.0
  #     MAX_SCORE_BASE: 1000000000.0
  #   }

  #   function document_age_days() {
  #     expression: max(0.0, if(isNan(attribute(createdTime)) == 1, THREE_MONTHS_IN_SECONDS / ONE_DAY_IN_SECONDS, (now() - (attribute(createdTime) / 1000)) / ONE_DAY_IN_SECONDS))
  #   }

  #   function recency_bin_index() {
  #     expression: floor(document_age_days() / query(bin_size_days))
  #   }

  #   function recency_bin_score() {
  #     expression: MAX_SCORE_BASE - (recency_bin_index() * RECENCY_BIN_MULTIPLIER)
  #   }

  #   function hybrid_relevance_score() {
  #     expression: (query(alpha) * vector_score()) + ((1 - query(alpha)) * combined_bm25)
  #   }

  #   first-phase {
  #     expression: recency_bin_score() + hybrid_relevance_score()
  #   }

  #   match-features {
  #     query(alpha)
  #     vector_score
  #     combined_bm25
  #     document_age_days
  #     recency_bin_index
  #     recency_bin_score
  #   }
  # }

  # Default native rank profile combining semantic vectors and nativeRank
  rank-profile default_native inherits initial {
    first-phase {
      expression: (query(alpha) * vector_score) + ((1 - query(alpha)) * combined_nativeRank)
    }

    global-phase {
      expression {
        (
          (query(alpha) * vector_score) +
          ((1 - query(alpha)) * combined_nativeRank)
        ) * doc_recency
      }
      rerank-count: 1000
    }

    match-features {
      matchedFieldCount
      vector_score
      combined_nativeRank
      nativeRank(subject)
      nativeRank(description)
      nativeRank(threadSummary)
      nativeRank(commentSummary)
      bm25(subject)
      bm25(description)
      bm25(threadSummary)
      bm25(commentSummary)
      doc_recency
      document_age
    }
  }

  ##########################################
  # 12. Summaries (for API/UI responses)
  ##########################################
  document-summary default {
    summary description {
      bolding: on
    }
    summary threadSummary {
      bolding: on
    }
    summary commentSummary {
      bolding: on
    }
    summary wholeResolutionSummary {
      bolding: on
    }
  }
}
