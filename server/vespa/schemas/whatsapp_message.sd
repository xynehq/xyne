schema whatsapp_message {
  document whatsapp_message {
    field docId type string {
      indexing: attribute | summary
    }

    field phoneNumber type string {
      indexing: attribute | summary
      attribute: fast-search
    }

    field text type string {
      indexing: index | summary
      index: enable-bm25
    }

    field timestamp type long {
      indexing: attribute | summary
      attribute: fast-search
    }

    field conversationId type string {
      indexing: attribute | summary
      attribute: fast-search
    }

    field app type string {
      indexing: attribute | summary
      attribute: fast-search
      match: exact
    }

    field entity type string {
      indexing: attribute | summary
      attribute: fast-search
      match: exact
    }

    field permissions type array<string> {
      indexing: attribute | summary
      attribute: fast-search
    }
  }

  fieldset default {
    fields: text, phoneNumber, conversationId, app, entity
  }

  rank-profile default {
    inputs {
      query(alpha) double
    }

    function scale(val) {
      expression: 2*atan(val/4)/(3.14159)
    }

    function scaled_bm25_text() {
      expression: scale(bm25(text))
    }

    function freshness_score() {
      expression: exp(-1 * (now() - attribute(timestamp)) / (3600 * 24))
    }

    first-phase {
      expression: bm25(text)
    }

    global-phase {
      expression {
        (
          nativeRank(text) * 5
        )
      }
      rerank-count: 1000
    }

    match-features {
      scaled_bm25_text
      freshness_score
    }
  }

  document-summary default {
    summary text {
      bolding: on
    }
    summary phoneNumber {
      bolding: on
    }
    summary conversationId {
      bolding: on
    }
  }
} 