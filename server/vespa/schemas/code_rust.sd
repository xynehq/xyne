schema code_rust {

  document code_rust {

    # --- Document ID ---
    # Use a hash of the file path as the document ID
    field docId type string {
      indexing: attribute | summary
      attribute: fast-search
    }

    # --- Struct Definitions ---
    # Simplified structs without indexing settings
    struct doc_comment {
      field text type string {}
      field target type string {}
      field start_line type int {}
    }

    struct dependency {
      field name type string {}
      field full_path type string {}
      field line type int {}
    }

    # --- File Metadata ---
    field filename type string {
      indexing: summary | attribute | index
      match: exact # Changed from word
      attribute: fast-search
    }

    field path type string {
      indexing: summary | attribute
      attribute: fast-search
    }

    field language type string {
      indexing: summary | attribute
      attribute: fast-search
    }

    # --- Core Content ---
    field raw_content type string {
      indexing: summary | index
      match: text # Keep as text for broader matching within content
      index: enable-bm25
      bolding: on
      # summary: dynamic # Reverted: Rely on mapper logic with code_chunk_contents
    }

    field symbol_names type array<string> {
      indexing: summary | attribute | index
      match: exact # Changed from word
      attribute: fast-search
    }

    # --- Flattened Code Chunks ---
    field code_chunk_kinds type array<string> {
      indexing: summary | attribute
      match: exact # Changed from word
      attribute: fast-search
    }
    field code_chunk_names type array<string> {
      indexing: summary | index
      match: exact # Changed from word
      index: enable-bm25
    }
    field code_chunk_contents type array<string> {
      indexing: summary | index # Keep for potential filtering/ranking
      match: text # Keep as text for broader matching within content
      bolding: on
      index: enable-bm25
      # summary: dynamic # Remove dynamic summary from here
    }
    field code_chunk_start_lines type array<int> {
      indexing: summary | attribute
    }
    field code_chunk_end_lines type array<int> {
      indexing: summary | attribute
    }

    # --- Documentation Comments ---
    field doc_comments_texts type array<string> {
      indexing: summary | index
      match: text # Keep as text
      bolding: on
      index: enable-bm25
    }
    field doc_comments_targets type array<string> {
      indexing: summary | attribute
      match: exact # Changed from word
      attribute: fast-search
    }
    field doc_comments_start_lines type array<int> {
      indexing: summary | attribute
    }

    # --- Dependencies ---
    field dependencies_names type array<string> {
      indexing: summary | index
      match: exact # Changed from word
    }
    field dependencies_full_paths type array<string> {
      indexing: summary | index
      match: exact # Changed from word
    }
    field dependencies_lines type array<int> {
      indexing: summary | attribute
    }

    # --- Feature Flags ---
    field feature_flags type array<string> {
      indexing: summary | attribute | index
      match: exact # Changed from word
      attribute: fast-search
    }

    # --- Embeddings ---
    field embedding type tensor<float>(x[1024]) {
      indexing: attribute
      attribute { distance-metric: angular }
    }

  }

  # --- Fieldsets ---
  fieldset default {
    fields: raw_content, symbol_names, code_chunk_names, code_chunk_contents, doc_comments_texts, dependencies_names, dependencies_full_paths, feature_flags
  }

  fieldset definitions {
    fields: code_chunk_contents
  }

  fieldset documentation {
    fields: doc_comments_texts
  }

  # --- Rank Profiles ---
  rank-profile default inherits default {
    # Define the elementwise calculation function at the profile level
    function chunk_scores() {
      expression: elementwise(bm25(code_chunk_contents), x, double)
    }

    first-phase {
      # Combine overall BM25 - REMOVED max_chunk_score usage
      expression: bm25(raw_content) + bm25(symbol_names)*2 + bm25(code_chunk_names)*3 + bm25(doc_comments_texts)*2
    }

    # Add chunk_scores to match-features
    match-features {
      bm25(raw_content)
      bm25(symbol_names)
      bm25(code_chunk_names)
      bm25(doc_comments_texts)
      chunk_scores # Keep the elementwise scores here
    }
  }

  rank-profile code_focused inherits default {
    # Define the elementwise calculation function at the profile level
    function chunk_scores() {
      expression: elementwise(bm25(code_chunk_contents), x, double)
    }

    first-phase {
      # Prioritize chunk names and symbols - REMOVED max_chunk_score usage
      expression: bm25(code_chunk_names)*4 + bm25(symbol_names)*2
    }

    # Add chunk_scores to match-features
    match-features {
      bm25(code_chunk_names)
      bm25(symbol_names)
      chunk_scores # Keep the elementwise scores here
    }
  }

  rank-profile doc_focused inherits default {
    # Define the elementwise calculation function at the profile level
    function chunk_scores() {
      expression: elementwise(bm25(code_chunk_contents), x, double)
    }

    first-phase {
      # Prioritize docs - REMOVED max_chunk_score usage
      expression: bm25(doc_comments_texts)*4 + bm25(code_chunk_names)*1.5 + bm25(symbol_names)
    }

    # Add chunk_scores to match-features
    match-features {
      bm25(doc_comments_texts)
      bm25(code_chunk_names)
      bm25(symbol_names)
      chunk_scores # Keep the elementwise scores here
    }
  }

  # --- Document Summaries ---
  # Default summary is implicitly created containing all fields with 'indexing: summary'
  # Explicit definition removed.

}
