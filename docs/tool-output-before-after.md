# Tool Output Standardization – Before & After

Recent changes to `server/api/chat/tools.ts` bring every internal tool in line with the `ToolOutput` schema that `MessageAgents` ( `server/api/chat/message-agents.ts` ) validates via `validateToolOutput`. The table below captures what changed per tool so we can keep the JAF hooks and prompts in sync.

| Tool | Before | After |
| --- | --- | --- |
| `searchGlobal` | Returned ad-hoc `{ result, contexts?, error? }` objects and threw on missing inputs. No metadata surfaced, so `message-agents.ts` could not populate `context.plan` telemetry reliably. | Uses `toolSuccess/toolError` helpers to emit schema-compliant objects, adds metadata (`query`, `app`, pagination), and guarantees missing-input errors are surfaced as structured failures so `beforeToolExecutionHook`/`afterToolExecutionHook` can log them. |
| `getSlackMessages` | Mixed success/error shapes and silently returned empty objects when Slack wasn’t enabled. `MessageAgents` couldn’t tell whether the call failed or simply produced no fragments. | Validates Slack access, propagates metadata (channel/user/query filters), and routes every outcome through the helpers. `afterToolExecutionHook` now always receives `contexts` + `metadata`, enabling consistent fragment tracking in `message-agents.ts:224-315`. |
| `getSlackUserProfile` | Inline responses with no metadata and inconsistent error messaging (`Missing target_user_email`). | Emits structured success with profile metadata and error responses via `toolError`, matching the schema that `validateToolOutput` enforces inside `message-agents.ts`. |
| `searchGmail` | Returned whatever `formatSearchToolResponse` produced (previously `{result, contexts}`) and manually handled errors. | Delegates to the updated formatter which already returns `ToolExecutionOutput` and enriches metadata, so `MessageAgents` can cite Gmail fragments without bespoke logic. Errors now flow through `toolError`. |
| `searchDriveFiles` | Same as Gmail: no metadata and ad-hoc error strings, meaning `message-agents.ts` could not distinguish validation failures. | Standardized output + metadata (`timeRange`, `limit`, etc.) and gating errors emitted through `toolError`, keeping `AgentRunContext.failedTools` accurate. |
| `searchCalendarEvents` | Had bespoke `{ result, error }` returns which occasionally omitted `contexts`. | Reuses formatter + helpers so success/error wiring mirrors the other tools, simplifying the `MessageAgents` prompt builder’s tool overview. |
| `searchGoogleContacts` | Similar to other search tools: ad-hoc error objects, no metadata. | Standardized via formatter; `MessageAgents` now receives consistent context fragments for contact lookups. |
| `fall_back` | Returned `{ result, fallbackReasoning }` on success and `{ result, error }` on failure; missing reasoning was an implicit failure. | Wraps responses in `toolSuccess/toolError` while still exposing `fallbackReasoning`. `MessageAgents` can therefore log fallback telemetry without special casing the tool. |

**Why this matters for `MessageAgents`**

- `message-agents.ts` relies on `afterToolExecutionHook` to accumulate fragments and telemetry. With every tool now emitting the `ToolOutput` shape defined in `tool-schemas.ts`, the hook can safely read `result`, `contexts`, and `metadata` without per-tool guards.
- The hook’s failure tracking (`failedTools` map) depends on `status === "success"`. Because each tool now calls `toolError` instead of returning plain strings, failures increment counters reliably, supporting the “stop after 3 strikes” logic described in `docs/jaf-unified-agentic-plan.md`.
- Prompt construction (`buildAgentInstructions` inside `message-agents.ts`) references `context.enabledTools`. Since every updated tool adheres to the schema, the prompt’s autogenerated descriptions (via `generateToolDescriptions`) match runtime behavior.

Keep this file updated as additional tools adopt the standardized output helpers so `MessageAgents` stays compatible with the rest of the agentic orchestration plan.
